import 'dotenv/config'; Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // à¹ƒà¸Šà¹‰ .env à¸•à¸­à¸™à¸à¸±à¸’à¸™à¸² local
import functions from 'firebase-functions';
import admin from 'firebase-admin';
import fetch from 'node-fetch';

if (!admin.apps.length) admin.initializeApp();
const db = admin.firestore();

const REGION = process.env.FUNCTION_REGION || 'asia-southeast1';
const SENDGRID_API_KEY = process.env.SENDGRID_API_KEY || '';
const SEND_FROM_EMAIL = process.env.SEND_FROM_EMAIL || 'teamluminej@gmail.com';
const SEND_FROM_NAME Â = process.env.SEND_FROM_NAME Â || 'LuminÃ© J';
const IMGBB_KEY = process.env.IMGBB_KEY || '';


// ---------------- Utils ----------------
const nowTs = () => admin.firestore.Timestamp.now();
const clampMoney = (n) => Math.max(0, Number.isFinite(n) ? Number(n) : 0);
const codeOf = (c) => String(c || '').trim().toUpperCase();

/* ===================== Push + Alerts helpers ===================== */

/** à¸­à¹ˆà¸²à¸™ deviceTokens à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ (à¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¸—à¸µà¹ˆ users/{uid}.deviceTokens: string[]) */
async function getUserDeviceTokens(uid) {
Â  try {
Â  Â  const u = await db.collection('users').doc(uid).get();
Â  Â  const data = u.exists ? u.data() : {};
Â  Â  const tokens = Array.isArray(data?.deviceTokens) ? data.deviceTokens.filter(Boolean) : [];
Â  Â  return tokens;
Â  } catch (e) {
Â  Â  console.warn('getUserDeviceTokens error:', e?.message || e);
Â  Â  return [];
Â  }
}

/** à¸­à¹ˆà¸²à¸™ deviceTokens à¸‚à¸­à¸‡à¹à¸­à¸”à¸¡à¸´à¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (users collection à¸—à¸µà¹ˆà¸¡à¸µ role == 'admin') */
async function getAllAdminDeviceTokens() {
Â  try {
Â  Â  const q = await db.collection('users').where('role', '==', 'admin').get();
Â  Â  const tokens = [];
Â  Â  q.docs.forEach(d => {
Â  Â  Â  const data = d.data() || {};
Â  Â  Â  const t = Array.isArray(data.deviceTokens) ? data.deviceTokens.filter(Boolean) : [];
Â  Â  Â  tokens.push(...t);
Â  Â  });
Â  Â  // unique
Â  Â  return Array.from(new Set(tokens));
Â  } catch (e) {
Â  Â  console.warn('getAllAdminDeviceTokens error:', e?.message || e);
Â  Â  return [];
Â  }
}

/** upsert admin notification (for admin dashboard) */
async function upsertAdminNotification({ threadId, userId, title, body, messageId }) {
Â  try {
Â  Â  const ref = db.collection('admin_notifications').doc(`${threadId}`);
Â  Â  await ref.set({
Â  Â  Â  threadId,
Â  Â  Â  userId,
Â  Â  Â  title,
Â  Â  Â  body,
Â  Â  Â  lastMessageId: messageId || null,
Â  Â  Â  read: false,
Â  Â  Â  updatedAt: admin.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  createdAt: admin.firestore.FieldValue.serverTimestamp(),
Â  Â  }, { merge: true });
Â  } catch (e) {
Â  Â  console.warn('upsertAdminNotification error:', e?.message || e);
Â  }
}

/** upsert admin notification for orders */
async function upsertAdminOrderNotification({ orderId, userId, title, body, orderNumber }) {
Â  try {
Â  Â  const ref = db.collection('admin_notifications').doc(`order_${orderId}`);
Â  Â  await ref.set({
Â  Â  Â  orderId,
Â  Â  Â  userId: userId || null,
Â  Â  Â  title: title || 'à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¹ƒà¸«à¸¡à¹ˆ',
Â  Â  Â  body: body || '',
Â  Â  Â  orderNumber: orderNumber || null,
Â  Â  Â  type: 'order',
Â  Â  Â  read: false,
Â  Â  Â  updatedAt: admin.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  createdAt: admin.firestore.FieldValue.serverTimestamp(),
Â  Â  }, { merge: true });
Â  } catch (e) {
Â  Â  console.warn('upsertAdminOrderNotification error:', e?.message || e);
Â  }
}

/**
Â * à¸ªà¹ˆà¸‡ FCM à¹à¸šà¸š "à¸­à¸±à¸™à¹€à¸”à¸µà¸¢à¸§/à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ" à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰:
Â * Â - android.notification.tag = orderId Â (à¹à¸—à¸™à¸—à¸µà¹ˆà¸šà¸™à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ)
Â * Â - android.collapseKey = orderId Â  Â  Â  (à¸£à¸§à¸¡à¸šà¸™ server à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸£à¸­à¸ªà¹ˆà¸‡)
Â */
async function sendOrderPlacedPush({ tokens, orderId, orderNumber, dateText, lines, grandTotal, brand = 'LuminÃ©J Official' }) {
Â  if (!tokens?.length) return;

Â  const bigText =
Â  Â  `à¸¢à¸·à¸™à¸¢à¸±à¸™à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¸„à¹ˆà¸°\n\n` +
Â  Â  `à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ: ${orderNumber}\n` +
Â  Â  `à¸§à¸±à¸™à¸—à¸µà¹ˆ: ${dateText}\n` +
Â  Â  `à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²:\n${(lines || []).map(x => `â€¢ ${x}`).join('\n')}\n` +
Â  Â  `à¸¢à¸­à¸”à¸Šà¸³à¸£à¸°à¸£à¸§à¸¡: à¸¿${grandTotal}\n\n` +
Â  Â  `à¸—à¸²à¸‡à¸£à¹‰à¸²à¸™à¸‚à¸­à¸‚à¸­à¸šà¸à¸£à¸°à¸„à¸¸à¸“à¸—à¸µà¹ˆà¹„à¸§à¹‰à¸§à¸²à¸‡à¹ƒà¸ˆà¹€à¸¥à¸·à¸­à¸à¹ƒà¸Šà¹‰à¸šà¸£à¸´à¸à¸²à¸£\n` +
Â  Â  `à¸—à¸µà¸¡à¸‡à¸²à¸™à¸ˆà¸°à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸ˆà¸±à¸”à¹€à¸•à¸£à¸µà¸¢à¸¡à¹à¸¥à¸°à¸ˆà¸±à¸”à¸ªà¹ˆà¸‡à¹‚à¸”à¸¢à¹€à¸£à¹‡à¸§à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¸„à¹ˆà¸°\n\n` +
Â  Â  `â€” ${brand}`;

Â  const message = {
Â  Â  tokens,
Â  Â  notification: {
Â  Â  Â  title: 'à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ',
Â  Â  Â  body: orderNumber, Â  Â  Â  Â  Â  Â  Â  Â  // à¸ªà¸±à¹‰à¸™ à¹† à¸šà¸™ heads-up
Â  Â  },
Â  Â  android: {
Â  Â  Â  priority: 'high',
Â  Â  Â  collapseKey: orderId, Â  Â  Â  Â  Â  Â  Â // âœ… à¸£à¸§à¸¡à¸šà¸™ server
Â  Â  Â  notification: {
Â  Â  Â  Â  channelId: 'orders_high', Â  Â  Â  Â // à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸š channel à¸à¸±à¹ˆà¸‡à¹à¸­à¸›
Â  Â  Â  Â  tag: orderId, Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // âœ… à¸„à¸µà¸¢à¹Œà¹à¸—à¸™à¸—à¸µà¹ˆà¸šà¸™à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ â†’ à¸­à¸±à¸™à¹€à¸”à¸µà¸¢à¸§/à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ
Â  Â  Â  Â  visibility: 'PUBLIC',
Â  Â  Â  },
Â  Â  },
Â  Â  data: {
Â  Â  Â  type: 'order',
Â  Â  Â  orderId,
Â  Â  Â  orderNumber,
Â  Â  Â  bigText, Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // à¹€à¸œà¸·à¹ˆà¸­à¹à¸­à¸›à¸­à¸¢à¸²à¸à¹‚à¸Šà¸§à¹Œ BigText à¹€à¸­à¸‡
Â  Â  },
Â  };

Â  await admin.messaging().sendMulticast(message);
}

/** upsert 1 à¹€à¸­à¸à¸ªà¸²à¸£/à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ à¹ƒà¸™ users/{uid}/alerts à¹€à¸à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸£à¸²à¸¢à¸à¸²à¸£à¸‹à¹‰à¸³ */
async function upsertOrderAlert({ uid, orderId, amount, itemsLines }) {
Â  const ref = db.collection('users').doc(uid).collection('alerts').doc(`order_${orderId}`);
Â  await ref.set({
Â  Â  type: 'order',
Â  Â  orderId,
Â  Â  title: 'Order placed',
Â  Â  message: 'Thanks for your purchase! Please wait for payment verification.',
Â  Â  amount: amount ?? null,
Â  Â  items: itemsLines || [],
Â  Â  status: 'unread',
Â  Â  createdAt: admin.firestore.FieldValue.serverTimestamp(),
Â  Â  updatedAt: admin.firestore.FieldValue.serverTimestamp(),
Â  }, { merge: true }); // âœ… à¸à¸±à¸™à¸‹à¹‰à¸³
}

/* ===================== Triggers / Callables ===================== */

// ---------- Trigger: send email on order create ----------
export const notifyOnOrderCreated = functions
Â  .region(REGION)
Â  .firestore.document('orders/{orderId}')
Â  .onCreate(async (snap, context) => {
Â  Â  try {
Â  Â  Â  const order = snap.data();
Â  Â  Â  if (!order) return null;

Â  Â  Â  const orderId = context.params.orderId;
Â  Â  Â  const customer = order.customer || {};
Â  Â  Â  const items = order.items || [];
Â  Â  Â  const pricing = order.pricing || {};

Â  Â  Â  const orderNumber = order.orderNumber || `#${orderId}`;
Â  Â  Â  const customerName = customer.name || customer.displayName || (order.userId || 'à¸¥à¸¹à¸à¸„à¹‰à¸²');
Â  Â  Â  const grandTotal = pricing?.grandTotal ?? order.total ?? order.subtotal ?? null;
Â  Â  Â  const lines = (items || []).map(i => `${i?.name || ''} Ã— ${i?.qty ?? i?.quantity ?? 0}`);

Â  Â  Â  // 1) notify admin devices (FCM)
Â  Â  Â  const adminTokens = await getAllAdminDeviceTokens();
Â  Â  Â  if (adminTokens.length) {
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  tokens: adminTokens,
Â  Â  Â  Â  Â  notification: {
Â  Â  Â  Â  Â  Â  title: 'à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¹ƒà¸«à¸¡à¹ˆ',
Â  Â  Â  Â  Â  Â  body: `${orderNumber} à¸ˆà¸²à¸ ${customerName}`,
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  android: {
Â  Â  Â  Â  Â  Â  priority: 'high',
Â  Â  Â  Â  Â  Â  notification: { channelId: 'orders_high', tag: orderId },
Â  Â  Â  Â  Â  Â  collapseKey: orderId,
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  type: 'order_admin',
Â  Â  Â  Â  Â  Â  orderId,
Â  Â  Â  Â  Â  Â  orderNumber: String(orderNumber),
Â  Â  Â  Â  Â  Â  amount: grandTotal != null ? String(grandTotal) : '',
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  };
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  await admin.messaging().sendMulticast(payload);
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.warn('send admin order push failed:', e?.message || e);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // 2) upsert admin_notifications so admin dashboard can show new orders
Â  Â  Â  try {
Â  Â  Â  Â  await upsertAdminOrderNotification({
Â  Â  Â  Â  Â  orderId,
Â  Â  Â  Â  Â  userId: order.userId || null,
Â  Â  Â  Â  Â  title: 'à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¹ƒà¸«à¸¡à¹ˆ',
Â  Â  Â  Â  Â  body: `à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­ ${orderNumber} à¸ˆà¸²à¸ ${customerName}`,
Â  Â  Â  Â  Â  orderNumber: orderNumber,
Â  Â  Â  Â  });
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.warn('upsertAdminOrderNotification failed:', e?.message || e);
Â  Â  Â  }

Â  Â  Â  console.log('notifyOnOrderCreated: processed order', orderId);
Â  Â  Â  return null;
Â  Â  } catch (err) {
Â  Â  Â  console.error('notifyOnOrderCreated error:', err);
Â  Â  Â  return null;
Â  Â  }
Â  });

// ---------- Callable: upload slip to ImgBB ----------
export const uploadImagesToImgBB = functions
Â  .region(REGION)
Â  .https.onCall(async (data, context) => {
Â  Â  const { images } = data || {};
Â  Â  if (!IMGBB_KEY) return { ok: false, reason: 'NO_IMGBB_KEY' };
Â  Â  if (!Array.isArray(images) || images.length === 0) return { ok: false, reason: 'NO_IMAGES' };

Â  Â  const urls = [];
Â  Â  for (const b64 of images) {
Â  Â  Â  const form = new URLSearchParams();
Â  Â  Â  form.append('key', IMGBB_KEY);
Â  Â  Â  form.append('image', b64);
Â  Â  Â  const resp = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: form });
Â  Â  Â  const json = await resp.json();
Â  Â  Â  if (!json.success) throw new functions.https.HttpsError('internal', 'IMGBB_UPLOAD_FAILED');
Â  Â  Â  urls.push(json.data.url);
Â  Â  }
Â  Â  return { ok: true, urls };
Â  });

export const uploadSlipToImgbb = uploadImagesToImgBB;

// ---------- applyCoupon ----------
export const applyCoupon = functions
Â  .region(REGION)
Â  .https.onCall(async (data, context) => {
Â  Â  const { userId, code, subtotal } = data || {};
Â  Â  if (!context.auth || context.auth.uid !== userId) return { ok: false, reason: 'UNAUTHORIZED' };
Â  Â  if (!code || typeof subtotal !== 'number') return { ok: false, reason: 'INVALID_INPUT' };

Â  Â  const couponCode = codeOf(code);
Â  Â  const snap = await db.collection('coupons').where('code', '==', couponCode).limit(1).get();
Â  Â  if (snap.empty) return { ok: false, reason: 'NOT_FOUND' };

Â  Â  const c = snap.docs[0].data();
Â  Â  const tsNow = nowTs();

Â  Â  if (!c.active) return { ok: false, reason: 'INACTIVE' };
Â  Â  if (c.expiresAt && c.expiresAt.toMillis() < tsNow.toMillis()) return { ok: false, reason: 'EXPIRED' };
Â  Â  if (c.minSpend && subtotal < c.minSpend) return { ok: false, reason: 'MIN_SPEND' };
Â  Â  if (c.usageLimit && (c.usedCount || 0) >= c.usageLimit) return { ok: false, reason: 'LIMIT_REACHED' };

Â  Â  if (c.perUserLimit) {
Â  Â  Â  const usageDoc = await db.collection('coupon_usages').doc(couponCode)
Â  Â  Â  Â  .collection('users').doc(userId).get();
Â  Â  Â  const usedByUser = usageDoc.exists ? (usageDoc.data()?.count || 0) : 0;
Â  Â  Â  if (usedByUser >= c.perUserLimit) return { ok: false, reason: 'PER_USER_LIMIT' };
Â  Â  }

Â  Â  let discount = 0;
Â  Â  if (c.type === 'percent') {
Â  Â  Â  discount = (Number(c.value) / 100) * subtotal;
Â  Â  Â  if (c.maxDiscount) discount = Math.min(discount, Number(c.maxDiscount));
Â  Â  } else if (c.type === 'fixed') {
Â  Â  Â  discount = Number(c.value);
Â  Â  }
Â  Â  discount = Math.max(0, Math.min(discount, subtotal));

Â  Â  return { ok: true, discount };
Â  });


// â­ï¸â­ï¸â­ï¸ [à¸™à¸µà¹ˆà¸„à¸·à¸­à¸ˆà¸¸à¸”à¸—à¸µà¹ˆà¹à¸à¹‰à¹„à¸‚] â­ï¸â­ï¸â­ï¸
// â­ï¸ à¸œà¸¡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸Šà¸·à¹ˆà¸­ 'createOrder' à¹€à¸›à¹‡à¸™ 'createOrderViaFunctions'
// â­ï¸ à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸šà¸—à¸µà¹ˆ PaymentService à¹ƒà¸™à¹à¸­à¸›à¸‚à¸­à¸‡à¸„à¸¸à¸“à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰ (à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² NOT_FOUND)
//
// â­ï¸ à¹à¸¥à¸°à¸­à¸±à¸›à¹€à¸”à¸•à¸•à¸£à¸£à¸à¸°à¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸•à¹‡à¸­à¸ (à¸šà¸£à¸£à¸—à¸±à¸” 360-381)
// â­ï¸ à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸šà¸—à¸µà¹ˆ CheckoutPage à¸„à¸²à¸”à¸«à¸§à¸±à¸‡ (à¹ƒà¸Šà¹‰ stock_map à¸à¹ˆà¸­à¸™)
//
// â­ï¸â­ï¸â­ï¸ [à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”à¸ˆà¸¸à¸”à¸—à¸µà¹ˆà¹à¸à¹‰à¹„à¸‚] â­ï¸â­ï¸â­ï¸
export const createOrderViaFunctions = functions
Â  .region(REGION)
Â  .https.onCall(async (data, context) => {
Â  Â  const { userId, items, couponCode, customer, pricing, payment } = data || {};
Â  Â  if (!context.auth || context.auth.uid !== userId) {
Â  Â  Â  throw new functions.https.HttpsError('unauthenticated', 'UNAUTHORIZED');
Â  Â  }
Â  Â  if (!Array.isArray(items) || items.length === 0) {
Â  Â  Â  throw new functions.https.HttpsError('invalid-argument', 'EMPTY_CART');
Â  Â  }

Â  Â  const orderRef = db.collection('orders').doc();

Â  Â  try {
Â  Â  Â  let result = null;
Â  Â  Â  await db.runTransaction(async (tx) => {
Â  Â  Â  Â  let subtotal = 0;
Â  Â  Â  Â  const finalizedItems = [];

Â  Â  Â  Â  for (const it of items) {
Â  Â  Â  Â  Â  const pid = String(it.productId);
Â  Â  Â  Â  Â  const qty = Number(it.qty) || 0;
Â  Â  Â  Â  Â  if (!pid || qty <= 0) throw new functions.https.HttpsError('invalid-argument', 'BAD_ITEM');

Â  Â  Â  Â  Â  const pRef = db.collection('products').doc(pid);
Â  Â  Â  Â  Â  const pSnap = await tx.get(pRef);
Â  Â  Â  Â  Â  if (!pSnap.exists) throw new functions.https.HttpsError('failed-precondition', `PRODUCT_NOT_FOUND:${pid}`);
Â  Â  Â  Â  Â  const p = pSnap.data();

Â  Â  Â  Â  Â  // â­ï¸ [à¹à¸à¹‰à¹„à¸‚] à¹à¸à¹‰à¹„à¸‚à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸•à¹‡à¸­à¸ à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸šà¹‚à¸„à¹‰à¸” Dart
Â  Â  Â  Â  Â  // â­ï¸ à¹ƒà¸Šà¹‰ stock_map à¸–à¹‰à¸²à¸¡à¸µ, fallback à¹„à¸›à¸—à¸µà¹ˆ stock
Â  Â  Â  Â  Â  const variantKey = it.variant ? `${it.variant.color}_${it.variant.size}` : null;
Â  Â  Â  Â  Â  const stockMap = p.stock_map || {}; // à¹ƒà¸Šà¹‰ || {} à¹€à¸à¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  let currentStock = 0;
Â  Â  Â  Â  Â  if (variantKey && stockMap[variantKey] != null) {
Â  Â  Â  Â  Â  Â  // 1. à¹ƒà¸Šà¹‰ stock_map
Â  Â  Â  Â  Â  Â  const rawStock = stockMap[variantKey];
Â  Â  Â  Â  Â  Â  currentStock = (typeof rawStock === 'number') ? rawStock : (parseInt(rawStock || '0', 10) || 0);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // 2. Fallback à¹„à¸›à¸—à¸µà¹ˆ 'stock'
Â  Â  Â  Â  Â  Â  const rawStock = p.stock;
Â  Â  Â  Â  Â  Â  currentStock = (typeof rawStock === 'number') ? rawStock : (parseInt(rawStock || '0', 10) || 0);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  if (currentStock < qty) {
Â  Â  Â  Â  Â  Â  const name = p.name || pid;
Â  Â  Â  Â  Â  Â  const variant = variantKey ? ` (${it.variant.color}/${it.variant.size})` : '';
Â  Â  Â  Â  Â  Â  // â­ï¸ à¹ƒà¸Šà¹‰ Error message à¸—à¸µà¹ˆ CheckoutPage à¸„à¸²à¸”à¸«à¸§à¸±à¸‡
Â  Â  Â  Â  Â  Â  throw new functions.https.HttpsError('failed-precondition', `à¸ªà¸´à¸™à¸„à¹‰à¸²à¸šà¸²à¸‡à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸•à¹‡à¸­à¸à¹„à¸¡à¹ˆà¸à¸­: ${name}${variant}`);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  // â­ï¸ [à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”] à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚à¸ªà¸•à¹‡à¸­à¸

Â  Â  Â  Â  Â  const unitPrice = Number(p.price) || Number(p.basePrice) || 0;
Â  Â  Â  Â  Â  subtotal += unitPrice * qty;

Â  Â  Â  Â  Â  finalizedItems.push({
Â  Â  Â  Â  Â  Â  productId: pid,
Â  Â  Â  Â  Â  Â  name: p.name,
Â  Â  Â  Â  Â  Â  price: unitPrice,
Â  Â  Â  Â  Â  Â  qty,
Â  Â  Â  Â  Â  Â  variant: it.variant ?? null,
Â  Â  Â  Â  Â  Â  image: Array.isArray(p.images) && p.images.length ? p.images[0] : null,
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  let discount = 0;
Â  Â  Â  Â  let appliedCode = null;

Â  Â  Â  Â  if (couponCode) {
Â  Â  Â  Â  Â  const couponCodeU = codeOf(couponCode);
Â  Â  Â  Â  Â  // â­ï¸ [à¹à¸à¹‰à¹„à¸‚] tx.get à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¸à¸±à¸š query à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡à¸ˆà¸²à¸ db.collection
Â  Â  Â  Â  Â  const qs = await tx.get(db.collection('coupons').where('code', '==', couponCodeU).limit(1));
Â  Â  Â  Â  Â  if (!qs.empty) {
Â  Â  Â  Â  Â  Â  const cRef = qs.docs[0].ref;
Â  Â  Â  Â  Â  Â  const c = qs.docs[0].data();
Â  Â  Â  Â  Â  Â  const tsNow = nowTs();

Â  Â  Â  Â  Â  Â  const valid =
Â  Â  Â  Â  Â  Â  Â  c.active &&
Â  Â  Â  Â  Â  Â  Â  (!c.expiresAt || c.expiresAt.toMillis() >= tsNow.toMillis()) &&
Â  Â  Â  Â  Â  Â  Â  (!c.usageLimit || (c.usedCount || 0) < c.usageLimit) &&
Â  Â  Â  Â  Â  Â  Â  (!c.minSpend || subtotal >= c.minSpend);

Â  Â  Â  Â  Â  Â  if (valid) {
Â  Â  Â  Â  Â  Â  Â  const usageRef = db.collection('coupon_usages').doc(couponCodeU).collection('users').doc(userId);
Â  Â  Â  Â  Â  Â  Â  const usageSnap = await tx.get(usageRef);
Â  Â  Â  Â  Â  Â  Â  const usedByUser = usageSnap.exists ? (usageSnap.data()?.count || 0) : 0;
Â  Â  Â  Â  Â  Â  Â  const perUserLimit = c.perUserLimit || null;

Â  Â  Â  Â  Â  Â  Â  if (!perUserLimit || usedByUser < perUserLimit) {
Â  Â  Â  Â  Â  Â  Â  Â  if (c.type === 'percent') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  discount = (Number(c.value) / 100) * subtotal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (c.maxDiscount) discount = Math.min(discount, Number(c.maxDiscount));
Â  Â  Â  Â  Â  Â  Â  Â  } else if (c.type === 'fixed') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  discount = Number(c.value);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  discount = Math.max(0, Math.min(discount, subtotal));
Â  Â  Â  Â  Â  Â  Â  Â  appliedCode = c.code;

Â  Â  Â  Â  Â  Â  Â  Â  tx.update(cRef, { usedCount: (c.usedCount || 0) + 1 });
Â  Â  Â  Â  Â  Â  Â  Â  tx.set(
Â  Â  Â  Â  Â  Â  Â  Â  Â  usageRef,
Â  Â  Â  Â  Â  Â  Â  Â  Â  { count: usedByUser + 1, updatedAt: admin.firestore.FieldValue.serverTimestamp() },
Â  Â  Â  Â  Â  Â  Â  Â  Â  { merge: true }
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const shippingFeeIn = pricing?.shippingFee != null ? Number(pricing.shippingFee) : 0;
Â  Â  Â  Â  const shippingFee = clampMoney(shippingFeeIn);
Â  Â  Â  Â  const total = clampMoney(+((subtotal - discount + shippingFee).toFixed(2)));

Â  Â  Â  Â  // â­ï¸ [à¹à¸à¹‰à¹„à¸‚] à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸•à¹‡à¸­à¸ (à¸£à¸­à¸‡à¸£à¸±à¸š stock_map)
Â  Â  Â  Â  for (const it of items) {
Â  Â  Â  Â  Â  const pRef = db.collection('products').doc(String(it.productId));
Â  Â  Â  Â  Â  const pSnap = await tx.get(pRef);
Â  Â  Â  Â  Â  const p = pSnap.data();
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  const variantKey = it.variant ? `${it.variant.color}_${it.variant.size}` : null;
Â  Â  Â  Â  Â  const stockMap = p.stock_map || {}; // à¹ƒà¸Šà¹‰ || {} à¹€à¸à¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  let updatePayload = {};
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if (variantKey && stockMap[variantKey] != null) {
Â  Â  Â  Â  Â  Â  // 1. à¸­à¸±à¸›à¹€à¸”à¸• stock_map
Â  Â  Â  Â  Â  Â  const rawStock = stockMap[variantKey];
Â  Â  Â  Â  Â  Â  const currentStock = (typeof rawStock === 'number') ? rawStock : (parseInt(rawStock || '0', 10) || 0);
Â  Â  Â  Â  Â  Â  updatePayload[`stock_map.${variantKey}`] = currentStock - Number(it.qty || 0);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // 2. Fallback à¸­à¸±à¸›à¹€à¸”à¸• 'stock'
Â  Â  Â  Â  Â  Â  const rawStock = p.stock;
Â  Â  Â  Â  Â  Â  const currentStock = (typeof rawStock === 'number') ? rawStock : (parseInt(rawStock || '0', 10) || 0);
Â  Â  Â  Â  Â  Â  updatePayload['stock'] = currentStock - Number(it.qty || 0);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  tx.update(pRef, updatePayload);
Â  Â  Â  Â  }
Â  Â  Â  Â  // â­ï¸ [à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”] à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸•à¹‡à¸­à¸

Â  Â  Â  Â  tx.set(orderRef, {
Â  Â  Â  Â  Â  userId,
Â  Â  Â  Â  Â  items: finalizedItems,
Â  Â  Â  Â  Â  subtotal: +subtotal.toFixed(2),
Â  Â  Â  Â  Â  discount: +discount.toFixed(2),
Â  Â  Â  Â  Â  total,
Â  Â  Â  Â  Â  couponCode: appliedCode ?? null,
Â  Â  Â  Â  Â  customer: {
Â  Â  Â  Â  Â  Â  name: customer?.name ?? '',
Â  Â  Â  Â  Â  Â  address: customer?.address ?? '',
Â  Â  Â  Â  Â  Â  phone: customer?.phone ?? '',
Â  Â  Â  Â  Â  Â  email: customer?.email ?? '',
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  pricing: {
Â  Â  Â  Â  Â  Â  subtotal: +subtotal.toFixed(2),
Â  Â  Â  Â  Â  Â  shippingFee: +shippingFee.toFixed(2),
Â  Â  Â  Â  Â  Â  grandTotal: total,
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  payment: {
Â  Â  Â  Â  Â  Â  method: payment?.method ?? 'transfer_qr',
Â  Â  Â  Â  Â  Â  slipUrl: payment?.slipUrl ?? '',
Â  Â  Â  Â  Â  Â  verified: false,
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  status: payment?.method === 'cod' ? 'pending_cod' : 'waiting_admin',
Â  Â  Â  Â  Â  requiresAdminConfirm: payment?.method !== 'cod',
Â  Â  Â  Â  Â  customerWillSendEmail: false,
Â  Â  Â  Â  Â  createdAt: admin.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  });

Â  Â  Â  Â  result = { ok: true, orderId: orderRef.id, subtotal, discount, total };
Â  Â  Â  });

Â  Â  Â  // ===== à¸ªà¹ˆà¸‡ FCM (à¸­à¸±à¸™à¹€à¸”à¸µà¸¢à¸§/à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ) + upsert alert à¸«à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ =====
Â  Â  Â  try {
Â  Â  Â  Â  const orderId = orderRef.id;
Â  Â  Â  Â  const orderNumber = `#${orderId}`; Â // à¸›à¸£à¸±à¸šà¹€à¸›à¹‡à¸™à¸Ÿà¸­à¸£à¹Œà¹à¸¡à¸•à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹„à¸”à¹‰
Â  Â  Â  Â  const dateText = new Date().toLocaleDateString('th-TH', {
Â  Â  Â  Â  Â  year: 'numeric', month: 'long', day: 'numeric'
Â  Â  Â  Â  });
Â  Â  Â  Â  // à¹à¸›à¸¥à¸‡à¸£à¸²à¸¢à¸à¸²à¸£à¸ˆà¸²à¸à¸à¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œ items à¹€à¸›à¹‡à¸™ "à¸Šà¸·à¹ˆà¸­ Ã— à¸ˆà¸³à¸™à¸§à¸™"
Â  Â  Â  Â  // â­ï¸ [à¹à¸à¹‰à¹„à¸‚] à¹ƒà¸Šà¹‰ finalizedItems à¸—à¸µà¹ˆà¸¡à¸µ name à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
Â  Â  Â  Â  const lines = (finalizedItems || []).map(it => `${it?.name || ''} Ã— ${it?.qty || 0}`);
Â  Â  Â  Â  const grand = (pricing?.grandTotal != null)
Â  Â  Â  Â  Â  ? Number(pricing.grandTotal)
Â  Â  Â  Â  Â  : (result?.total ?? null);

Â  Â  Â  Â  // 1) à¸ªà¹ˆà¸‡ Push à¹à¸šà¸šà¹à¸—à¸™à¸—à¸µà¹ˆà¸”à¹‰à¸§à¸¢ tag/collapseKey = orderId
Â  Â  Â  Â  const tokens = await getUserDeviceTokens(userId);
Â  Â  Â  Â  await sendOrderPlacedPush({
Â  Â  Â  Â  Â  tokens,
Â  Â  Â  Â  Â  orderId,
Â  Â  Â  Â  Â  orderNumber,
Â  Â  Â  Â  Â  dateText,
Â  Â  Â  Â  Â  lines,
Â  Â  Â  Â  Â  grandTotal: grand,
Â  Â  Â  Â  Â  brand: 'LuminÃ©J Official',
Â  Â  Â  Â  });

Â  Â  Â  Â  // 2) upsert 1 à¹€à¸­à¸à¸ªà¸²à¸£/à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ à¹ƒà¸™ users/{uid}/alerts
Â  Â  Â  Â  await upsertOrderAlert({
Â  Â  Â  Â  Â  uid: userId,
Â  Â  Â  Â  Â  orderId,
Â  Â  Â  Â  Â  amount: grand,
Â  Â  Â  Â  Â  itemsLines: lines,
Â  Â  Â  Â  });

Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.warn('send push / upsert alert skipped:', e?.message || e);
Â  Â  Â  }
Â  Â  Â  // ===========================================================

Â  Â  Â  return result;
Â  Â  } catch (err) {
Â  Â  Â  console.error('createOrder error:', err);
Â  Â  Â  // â­ï¸ [à¹à¸à¹‰à¹„à¸‚] à¸ªà¹ˆà¸‡ Error à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸¡à¸´à¸•à¸£à¸à¸¥à¸±à¸šà¹„à¸›
Â  Â  Â  if (err.code === 'failed-precondition' && err.message.startsWith('à¸ªà¸´à¸™à¸„à¹‰à¸²à¸šà¸²à¸‡à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸•à¹‡à¸­à¸à¹„à¸¡à¹ˆà¸à¸­')) {
Â  Â  Â  Â  throw new functions.https.HttpsError('failed-precondition', err.message);
Â  Â  Â  }
Â  Â  Â  throw new functions.https.HttpsError('internal', String(err?.message || err));
Â  Â  }
Â  });


/**
Â * ------------------------------------------------------------
Â * ğŸ—¨ï¸ à¸£à¸°à¸šà¸šà¹à¸Šà¸—à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´: onThreadCreateWelcome
Â * ------------------------------------------------------------
Â */
export const onThreadCreateWelcome = functions
Â  .region(REGION)
Â  .firestore.document('threads/{threadId}')
Â  .onCreate(async (snap, context) => {
Â  Â  try {
Â  Â  Â  const threadId = context.params.threadId;
Â  Â  Â  const data = snap.data() || {};
Â  Â  Â  const participants = data.participants || [];
Â  Â  Â  const STORE_ID = 'STORE_Chat';

Â  Â  Â  if (!participants.includes(STORE_ID)) return null;
Â  Â  Â  if (data.autoWelcomed === true) return null;

Â  Â  Â  const BUSINESS_HOURS = 'à¹€à¸§à¸¥à¸²à¸—à¸³à¸à¸²à¸£ 10:00â€“20:00 à¸—à¸¸à¸à¸§à¸±à¸™';
Â  Â  Â  const WELCOME_1 = 'à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸° à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¸•à¸´à¸”à¸•à¹ˆà¸­à¸£à¹‰à¸²à¸™ LuminÃ© J ğŸ’–';
Â  Â  Â  const WELCOME_2 = 'à¸«à¸²à¸à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸ªà¸­à¸šà¸–à¸²à¸¡à¸ªà¸´à¸™à¸„à¹‰à¸²à¸«à¸£à¸·à¸­à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™ à¸ªà¸²à¸¡à¸²à¸£à¸–à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸„à¹ˆà¸°';
Â  Â  Â  const WELCOME_3 = `ğŸ“¦ à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸•à¸´à¸”à¸•à¸²à¸¡à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­ à¸à¸£à¸¸à¸“à¸²à¹„à¸›à¸—à¸µà¹ˆà¸«à¸™à¹‰à¸² â€œà¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ > à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­â€\n${BUSINESS_HOURS}`;

Â  Â  Â  const threadRef = db.collection('threads').doc(threadId);
Â  Â  Â  const msgsRef = threadRef.collection('messages');
Â  Â  Â  const batch = db.batch();
Â  Â  Â  const now = admin.firestore.FieldValue.serverTimestamp();

Â  Â  Â  const m1 = msgsRef.doc();
Â  Â  Â  batch.set(m1, { senderId: STORE_ID, type: 'text', text: WELCOME_1, imageUrl: null, createdAt: now, readBy: [] });
Â  Â  Â  const m2 = msgsRef.doc();
Â  Â  Â  batch.set(m2, { senderId: STORE_ID, type: 'text', text: WELCOME_2, imageUrl: null, createdAt: now, readBy: [] });
Â  Â  Â  const m3 = msgsRef.doc();
Â  Â  Â  batch.set(m3, { senderId: STORE_ID, type: 'text', text: WELCOME_3, imageUrl: null, createdAt: now, readBy: [] });

Â  Â  Â  batch.update(threadRef, {
Â  Â  Â  Â  autoWelcomed: true,
Â  Â  Â  Â  lastMessage: WELCOME_3,
Â  Â  Â  Â  lastSender: STORE_ID,
Â  Â  Â  Â  lastAt: now,
Â  Â  Â  });

Â  Â  Â  await batch.commit();
Â  Â  Â  console.log(`âœ… à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹ƒà¸«à¹‰à¸¥à¸¹à¸à¸„à¹‰à¸²à¹ƒà¸™ thread ${threadId}`);
Â  Â  Â  return null;
Â  Â  } catch (err) {
Â  Â  Â  console.error('âŒ onThreadCreateWelcome error:', err);
Â  Â  Â  return null;
Â  Â  }
Â  });


/**
Â * Trigger: when a new chat message is created under threads/{threadId}/messages/{messageId}
Â * - If customer sends -> notify admin devices + upsert admin_notifications
Â * - If store (STORE_Chat) sends -> notify the specific customer and create users/{uid}/alerts
Â */
export const onMessageCreated = functions
Â  .region(REGION)
Â  .firestore.document('threads/{threadId}/messages/{messageId}')
Â  .onCreate(async (snap, context) => {
Â  Â  try {
Â  Â  Â  const message = snap.data() || {};
Â  Â  Â  const threadId = context.params.threadId;
Â  Â  Â  const messageId = context.params.messageId;
Â  Â  Â  const senderId = message.senderId;
Â  Â  Â  const text = (message.text || '')?.toString() || '';
Â  Â  Â  const isSystem = message.system === true;

Â  Â  Â  if (isSystem) return null; // don't notify for system messages

Â  Â  Â  const threadRef = db.collection('threads').doc(threadId);
Â  Â  Â  const threadSnap = await threadRef.get();
Â  Â  Â  if (!threadSnap.exists) return null;
Â  Â  Â  const thread = threadSnap.data() || {};
Â  Â  Â  const userId = thread.userId;
Â  Â  Â  const store = thread.storeId || thread.store || 'STORE_Chat';

Â  Â  Â  // If sender is the store (admin side), notify the user
Â  Â  Â  if (senderId === store) {
Â  Â  Â  Â  if (!userId) return null;
Â  Â  Â  Â  const tokens = await getUserDeviceTokens(userId);
Â  Â  Â  Â  if (tokens.length) {
Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  tokens,
Â  Â  Â  Â  Â  Â  notification: {
Â  Â  Â  Â  Â  Â  Â  title: 'à¸£à¹‰à¸²à¸™à¸•à¸­à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸‚à¸­à¸‡à¸„à¸¸à¸“',
Â  Â  Â  Â  Â  Â  Â  body: text.length > 120 ? text.substring(0, 117) + '...' : text || 'à¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸à¸£à¹‰à¸²à¸™',
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  android: {
Â  Â  Â  Â  Â  Â  Â  priority: 'high',
Â  Â  Â  Â  Â  Â  Â  notification: { channelId: 'chat_messages', tag: threadId },
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  data: { type: 'chat', threadId, messageId, threadUserId: userId },
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  await admin.messaging().sendMulticast(payload);
Â  Â  Â  Â  }

Â  Â  Â  Â  // also add an in-app alert for the user
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  await db.collection('users').doc(userId).collection('alerts').add({
Â  Â  Â  Â  Â  Â  type: 'chat',
Â  Â  Â  Â  Â  Â  threadId,
Â  Â  Â  Â  Â  Â  title: 'à¸•à¸­à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ˆà¸²à¸à¸£à¹‰à¸²à¸™',
Â  Â  Â  Â  Â  Â  message: text || 'à¸£à¹‰à¸²à¸™à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¡à¸²à¸«à¸²à¸„à¸¸à¸“',
Â  Â  Â  Â  Â  Â  status: 'unread',
Â  Â  Â  Â  Â  Â  createdAt: admin.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.warn('failed to create user alert for chat:', e?.message || e);
Â  Â  Â  Â  }

Â  Â  Â  Â  return null;
Â  Â  Â  }

Â  Â  Â  // Otherwise sender is a customer -> notify admins
Â  Â  Â  const adminTokens = await getAllAdminDeviceTokens();
Â  Â  Â  if (adminTokens.length) {
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  tokens: adminTokens,
Â  Â  Â  Â  Â  notification: {
Â  Â  Â  Â  Â  Â  title: `à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ˆà¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸² ${thread.userDisplayName || userId}`,
Â  Â  Â  Â  Â  Â  body: text.length > 120 ? text.substring(0, 117) + '...' : text || 'à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ',
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  android: { priority: 'high', notification: { channelId: 'admin_chat', tag: threadId } },
Â  Â  Â  Â  Â  data: { type: 'chat_admin', threadId, messageId, userId },
Â  Â  Â  Â  };
Â  Â  Â  Â  await admin.messaging().sendMulticast(payload);
Â  Â  Â  }

Â  Â  Â  // upsert admin_notifications so admin dashboard shows the thread with latest message
Â  Â  Â  await upsertAdminNotification({ threadId, userId, title: `à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ˆà¸²à¸ ${thread.userDisplayName || userId}`, body: text, messageId });

Â  Â  Â  return null;
Â  Â  } catch (err) {
Â  Â  Â  console.error('onMessageCreated error:', err);
Â  Â  Â  return null;
Â  Â  }
Â  });